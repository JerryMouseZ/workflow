# 可直接复制为 workflow/config.toml 并按需修改

[workflow]
rounds = 1
log_dir = "workflow/logs"
state_file = "workflow/state.json"
# 初始基准值：第一轮没有上轮数据时使用
initial_qps = 3500
initial_recall = 0.858

[[steps]]
type = "profile_analyze"
name = "profile"
analyze_cmd = ["python3", "test/analyze_self_time.py"]
# “unknown/缺失栈”等默认跳过：可按需追加
ignore_regex = ["^\\[.*\\]$", "(?i)unknown"]

# 你也可以在 profile_analyze 前插入任意脚本（可插拔）
# 例如：先跑一次带 profile 的 benchmark 生成最新 .folded
# [[steps]]
# type = "command"
# name = "generate_profile"
# command = "bash test/run_benchmark.sh --restore_index_backup --profile"

[[steps]]
type = "target_select"
name = "target"
# top_self_percent | top_samples
strategy = "top_self_percent"
pick_top_k = 3

[[steps]]
type = "context_collect"
name = "context"
search_roots = ["polardb"]
max_files = 20
snippet_radius = 50
max_total_matches = 120

[[steps]]
type = "codex_generate_kiro_prompt"
name = "codex_plan"
codex_cmd = ["codex", "exec", "--dangerously-bypass-approvals-and-sandbox"]
prompt_file = "workflow/prompts/codex_generate_kiro.md"
max_context_chars = 12000

[[steps]]
type = "kiro_apply_and_test"
name = "kiro"
kiro_cmd = ["kiro-cli", "chat", "-a"]
retry_prompt_file = "workflow/prompts/kiro_retry.md"
max_iterations = 5

# 下面两类命令都通过 bash -lc 执行；请按你的环境/容器实际可用命令调整
build_cmds = [
  "cd polardb && make install-world-bin -j32 && ~/tmp_polardb_pg_15_base/bin/pg_ctl stop -D ~/tmp_polardb_pg_15_primary",
]
test_cmds = [
  "cd polardb && make -C src/test/regress check -j32",
]

[[steps]]
type = "benchmark"
name = "bench"
warmup = 3
runs = 10
command = "cd test && bash run_benchmark.sh --base_file dataset_10M/base.10M.filtered.fbin --query_file dataset_10M/10M.query.10000.fbin --gt_file dataset_10M/10M.groundtruth.10000.ibin --skip_load --skip_index --profile"
qps_regex = ".*QPS is: ([0-9.]+)"
recall_regex = "avg recall@\\d+ of \\d+ queries is: ([0-9.]+)"

[[steps]]
type = "codex_git_decide"
name = "codex_git"
codex_cmd = ["codex", "exec", "--dangerously-bypass-approvals-and-sandbox"]
prompt_file = "workflow/prompts/codex_git_decide.md"
# codex | local（local=由本脚本执行git，codex只给出结构化决策）
mode = "codex"
